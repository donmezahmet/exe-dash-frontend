<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Department Executive Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
    }

header {
  background-color: #5D3EBC;
  color: #FFD10D;
  font-size: 24px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  letter-spacing: 0.3px;
   height: 60px;
  line-height: 60px; /* yazıyı dikeyde ortalar */
  padding: 0 40px;
}
.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  height: 36px;   /* Gerekirse burayı değiştirerek logo boyutunu ayarlayabilirsin */
  vertical-align: middle;
}

.dashboard-title {
  font-size: 24px;
  font-weight: 600;
  color: #FFD10D;
}


    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 40px;
      padding: 40px;
    }

   .row {
  display: flex;
  flex-wrap: wrap;
  gap: 40px;
  width: 100%;
  align-items: flex-start;  /* ✅ Bu satırı ekleyin */
}


.card {
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
  flex: 0 1 600px; /* flex-grow: 0 olacak şekilde güncellendi */
  max-width: 650px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}


  .card-full {
  max-width: 100% !important;
  flex: 1 1 100% !important;
}


    h2 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    canvas {
      width: 100% !important;

    }

    .dropdown-multiselect {
  width: 100%;
  margin-bottom: 12px;
}

select[multiple] {
  width: 70%;
  max-height: 42px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

.choices__list--multiple {
  display: flex !important;
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  padding: 4px 0;
  margin: 0;
  width: 100%;
}



.choices[data-type*="select-multiple"] .choices__list--dropdown {
  width: auto !important;
  min-width: 300px !important;
}
.choices__item .choices__button {
  margin-left: 8px;
  color: #fff;
  font-weight: bold;
  font-size: 12px;
}
.choices__list--multiple .choices__item {
  background-color: #007b8a;
  color: #fff;
  border-radius: 20px;
  padding: 5px 10px;
  margin: 0 6px 0 0; /* üstten boşluk kaldırıldı */
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  white-space: nowrap; /* ✅ Taşmayı engeller */
}



.choices__inner {
  max-height: 44px !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: center;
}

    #riskTextChart {
      width: 100%;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      color: #2c3e50;
    }

    .legend {
      margin-top: 10px;
      width: 100%;
      font-size: 14px;
    }

#controlRiskTableContainer {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  display: inline-block;        /* ✅ içeriğe göre yükseklik ayarlar */
}

#controlRiskTableContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
  table-layout: fixed; /* ✅ Bu satırı ekle */
}

#controlRiskTableContainer td:first-child,
#controlRiskTableContainer th:first-child {
  text-align: left;
  width: 160px;              /* ✅ Tek bir width değeri yeterli */
  word-break: break-word;
  white-space: normal;
}


#controlRiskTableContainer th,
#controlRiskTableContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

#controlRiskTableContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

#controlRiskTableContainer td {
  background-color: #ffffff;
}

#controlRiskTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

#controlRiskTableContainer td:first-child {
  text-align: left;
  max-width: 140px;
  min-width: 40px;
  word-break: break-word;
  white-space: normal;
}

#controlRiskTableContainer th:first-child {
  max-width: 140px;
  min-width: 40px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}
.card.compact-table-card {
  padding: 20px 20px 10px 20px !important; /* Alt padding azaltıldı */
}


 #typeRiskTableContainer {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  display: inline-block;
}

#typeRiskTableContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
  table-layout: fixed; /* ✅ Eklendi */
}

#typeRiskTableContainer th,
#typeRiskTableContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

#typeRiskTableContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

#typeRiskTableContainer td {
  background-color: #ffffff;
}

#typeRiskTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

#typeRiskTableContainer td:first-child,
#typeRiskTableContainer th:first-child {
  text-align: left;
  width: 140px; /* ✅ Tek bir width ile sınırlandırıldı */
  word-break: break-word;
  white-space: normal;
}


.filter-row .filter-group {
  flex-direction: row;
  align-items: center;
}
.filter-row .filter-group label {
  margin-bottom: 0;
  margin-right: 8px;
}

.filter-group .choices {
  width: 100%;
  max-width: 300px;
}

/* Bu kural, başlığı sola, butonu sağa yaslar ve aynı satıra getirir */
/* This rule aligns the title to the left and the button to the right */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin-bottom: 20px; /* ✅ FİLTREYİ AŞAĞI ALMAK İÇİN BU SATIRI EKLEYİN */
}
/* Başlığın kendi alt boşluğunu sıfırlayarak hizalamayı düzeltiyoruz */
.card-header h2 {
    margin-bottom: 0;
}

/* This rule aligns the filter(s) to the right */



    #detailBox {
      display: none;
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      border-radius: 10px;
    }

    #detailBox button {
      float: right;
    }

    #detailBox h3 {
      margin-top: 0;
    }

    #detailBox ul {
      padding-left: 20px;
    }

    #detailBox li {
      margin-bottom: 6px;
    }

    .score-card-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: flex-start;
}

.score-card-container2 {
  display: flex;
  flex-wrap: wrap;
  gap: 40px;
  justify-content: flex-start;
}
.score-card {
  background-color: #1c1f26;
  color: #ecf0f1;
  border-radius: 12px;
  padding: 20px 30px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  text-align: center;
  min-width: 120px;
  flex: 1 0 120px;
}

.score-card h3 {
  font-size: 20px;
  margin: 0;
  color: #3498db;
}

.score-card p {
  font-size: 14px;
  margin: 6px 0 4px;
  color: #95a5a6;
}

.score-card .count {
  font-size: 28px;
  font-weight: bold;
  color: #2ecc71;
}
#projectRiskTableContainer {
  width: 100%;
  max-height: 400px;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#projectRiskTableContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
}

#projectRiskTableContainer th,
#projectRiskTableContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

/* Başlıklar */
#projectRiskTableContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

/* Tüm veri hücreleri */
#projectRiskTableContainer td {
  background-color: #ffffff;
}

/* Alternatif satır rengi */
#projectRiskTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

/* İlk sütun sola hizalanacak */
#projectRiskTableContainer td:first-child {
  text-align: left;
  max-width: 260px;
  min-width: 200px;
  word-break: break-word;
  white-space: normal;
}

/* İlk sütun başlığı ortada ama genişlik aynı */
#projectRiskTableContainer th:first-child {
  max-width: 260px;
  min-width: 200px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}


@media (max-width: 1000px) {
  .card {
    max-width: 100%;
  }
}

#auditNameStatusTableContainer {
  width: 100%;
  max-height: 600px;
  overflow-x: auto;         /* yatay scroll burada */
  overflow-y: auto;         /* dikey scroll burada */
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#auditNameStatusTableContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
}

#auditNameStatusTableContainer th,
#auditNameStatusTableContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

/* Başlıklar */
#auditNameStatusTableContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

/* Tüm veri hücreleri */
#auditNameStatusTableContainer td {
  background-color: #ffffff;
}

/* Alternatif satır rengi */
#auditNameStatusTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

/* Sadece ilk sütun hücreleri sola hizalanır, başlık dahil değil */
#auditNameStatusTableContainer td:first-child {
  text-align: left;
  max-width: 260px;
  min-width: 200px;
  word-break: break-word;
  white-space: normal;
}

/* İlk sütun başlığı ortada kalsın ama genişlik aynı kalsın */
#auditNameStatusTableContainer th:first-child {
  max-width: 260px;
  min-width: 200px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}

#auditProgressWrapper {
  width: 100%;
  position: relative;
  max-height: 550px;        /* Maksimum yüksekliği belirliyoruz */
  overflow-y: auto;         /* Taşarsa scroll çıksın */
  margin-top: 10px;
  padding: 0;
  padding-right: 10px;      /* scroll bar boşluğu */
}

#auditProgressChart {
  width: 100% !important;
  height: 100% !important;
}

#auditProgressWrapper {
  max-height: 360px;
  overflow-y: auto;
}

/* Scroll dışına taşmasını engelle, margin kalsın */
.audit-table-wrapper {
  flex: 2;
  height: 100%;
  min-height: 480px;
  overflow: hidden;
  margin-top: 36px;
}

.auto-height-card {
  flex: none !important;
}

.card.auto-height-card {
  padding-bottom: 20px !important; /* Alt boşluğu azalt */
  min-height: unset !important;    /* Varsayılan minimum yükseklik varsa iptal et */
  height: auto !important;         /* Kart içeriğe göre boylansın */
}
.top-scorecards {
  justify-content: center; /* ortalar */
  width: 100%;
  display: flex;
  gap: 40px;
  margin-bottom: 40px;
}
 #fraudImpactTableContainer {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  display: inline-block;
}

#fraudImpactTableContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
  table-layout: fixed; /* ✅ Eklendi */
}

#fraudImpactTableContainer th,
#fraudImpactTableContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

#fraudImpactTableContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

#fraudImpactTableContainer td {
  background-color: #ffffff;
}

#fraudImpactTableContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

#fraudImpactTableContainer td:first-child,
#fraudImpactTableContainer th:first-child {
  text-align: left;
  width: 100px; /* ✅ Tek bir width ile sınırlandırıldı */
  word-break: break-word;
  white-space: normal;
}

 #fraudImpactLocalContainer {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  display: inline-block;
}

#fraudImpactLocalContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
  table-layout: fixed; /* ✅ Eklendi */
}

#fraudImpactLocalContainer th,
#fraudImpactLocalContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

#fraudImpactLocalContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

#fraudImpactLocalContainer td {
  background-color: #ffffff;
}

#fraudImpactLocalContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

#fraudImpactLocalContainer td:first-child,
#fraudImpactLocalContainer th:first-child {
  text-align: left;
  width: 100px; /* ✅ Tek bir width ile sınırlandırıldı */
  word-break: break-word;
  white-space: normal;
}


 #lossPreventionSummaryContainer {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  background-color: #ffffff;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  display: inline-block;
}

#lossPreventionSummaryContainer table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
  color: #2c3e50;
  table-layout: fixed; /* ✅ Eklendi */
}

#lossPreventionSummaryContainer th,
#lossPreventionSummaryContainer td {
  padding: 10px 12px;
  text-align: center;
  border: 1px solid #e1e4e8;
  line-height: 1.4;
}

#lossPreventionSummaryContainer th {
  background-color: #f2f4f7;
  font-weight: 600;
  color: #333;
  white-space: nowrap;
}

#lossPreventionSummaryContainer td {
  background-color: #ffffff;
}

#lossPreventionSummaryContainer tr:nth-child(even) td {
  background-color: #f9f9f9;
}

#lossPreventionSummaryContainer td:first-child,
#lossPreventionSummaryContainer th:first-child {
  text-align: left;
  width: 100px; /* ✅ Tek bir width ile sınırlandırıldı */
  word-break: break-word;
  white-space: normal;
}
.login-card {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 90vh;
    background-color: #5D3EBC; /* Arka plan tek renk */
}

.login-content {
  background-color: white;
  padding: 40px 30px;
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  text-align: center;
  width: 100%;
  max-width: 400px;
}

.login-logo {
  width: 100px;
  margin-bottom: 10px;
}

.login-content h2 {
  font-size: 1.2rem;
  margin-bottom: 20px;
  color: #333;
}

.login-divider {
  display: flex;
  align-items: center;
  margin: 20px 0;
  color: #666;
  font-size: 14px;
}

.login-divider::before,
.login-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: #ddd;
}

.login-divider span {
  padding: 0 15px;
}

.google-login-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 12px;
  margin-bottom: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #fff;
  color: #757575;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: box-shadow 0.2s;
}

.google-login-btn:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  text-decoration: none;
  color: #757575;
}

.google-icon {
  width: 18px;
  height: 18px;
  margin-right: 12px;
}

.login-content input {
  display: block;
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1rem;
}

.login-content button {
  background-color: #ffcc00;
  color: #000;
  font-weight: bold;
  padding: 12px;
  border: none;
  border-radius: 8px;
  width: 100%;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s ease;
}

.login-content button:hover {
  background-color: #e6b800;
}

.login-error {
  color: red;
  font-size: 0.9rem;
  margin-top: 10px;
}
.score-card-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

.score-card {
  background-color: #1c1c1c;
  color: #fff;
  padding: 20px;
  width: 200px;
  text-align: center;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.score-year {
  font-size: 24px;
  font-weight: bold;
  color: #3ea6ff;
}

.score-value {
  font-size: 28px;
  font-weight: bold;
  color: #4ade80;
}

.score-sub {
  font-size: 16px;
  color: #ccc;
  margin-top: 6px;
}

.scorecard-row {
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
  margin-bottom: 40px;
}



.score-card-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}
/* BU KURALI BULUP DEĞİŞTİRİN */
.btn-export {
  background-color: #2ecc71;
  color: white;
  padding: 6px 12px;      /* 8px 16px'dan küçültüldü */
  font-size: 13px;        /* 14px'den küçültüldü */
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-export:hover {
  background-color: #27ae60;
}



/* BU KURALI DA BULUP DEĞİŞTİRİN */
#exportFindingActionsBtn.btn-export {
    background-color: #FFD100;
    color: #5D3EBC;
    border: none;
    padding: 6px 12px; /* 8px 16px'dan küçültüldü */
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

    #exportFindingActionsBtn.btn-export:hover {
      background-color: #f6c700;
    }


.filter-row .filter-group {
  flex-direction: row; /* Dikey olan hizalamayı YATAY yapar */
  align-items: center;   /* Etiket ve filtreyi dikeyde ortalar */
}

/* Bu kural, yatay hizalamada etiketin altındaki gereksiz boşluğu kaldırır */
.filter-row .filter-group label {
  margin-bottom: 0;
  margin-right: 8px; /* Etiket ile filtre arasına boşluk ekler */
}


/* Fraud Impact tablosundaki ilk sütun hariç tüm veri hücrelerini sağa yaslar */
#fraudImpactTableContainer td:not(:first-child) {
  text-align: right;
}




/* Loss Prevention tablosundaki ilk sütun hariç tüm veri hücrelerini sağa yaslar */
#lossPreventionSummaryContainer td:not(:first-child) {
  text-align: right;
}
  </style>
</head>
<body>
 <header>
  <div class="header-content">
    <img src="logo.png" alt="Logo" class="logo">
    <span>Audit Department Executive Dashboard</span>
  </div>
</header>

<!-- Login Section -->
<div id="loginSection" class="login-card">
  <div class="login-content">
    <img src="logo.png" alt="Getir Logo" class="login-logo">
    <h2>Audit Department Executive Dashboard</h2>

    <!-- Google SSO Login Button -->
    <a href="https://exe-dash-backend.onrender.com/api/auth/google" class="google-login-btn">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </a>

    <p id="loginError" class="login-error"></p>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Check if user is already authenticated on page load
    checkAuthStatus();

    // Check for OAuth callback parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('error') === 'oauth_failed') {
      document.getElementById('loginError').innerText = 'Google authentication failed. Please try again.';
    }
  });

  async function checkAuthStatus() {
    try {
      const response = await fetch('https://exe-dash-backend.onrender.com/api/auth/status', {
        credentials: 'include'
      });
      const data = await response.json();

      if (data.authenticated) {
        console.log("✅ User already authenticated:", data.user);
        showDashboard();
      }
    } catch (error) {
      console.log("User not authenticated, showing login form");
    }
  }

  function showDashboard() {
    // Hide login panel
    const loginSection = document.getElementById('loginSection');
    if (loginSection) loginSection.style.display = 'none';

    // Show dashboard
    const dashboard = document.getElementById('dashboardContainer');
    if (dashboard) {
      dashboard.style.display = 'block';
      dashboard.style.visibility = 'visible';
      dashboard.style.opacity = 1;
    }

    // Initialize dashboard
    if (typeof initializeDashboard === 'function') {
      initializeDashboard();
    }
  }
</script>
  <div class="card">
    <h2>Investigations by Year</h2>
    <div class="score-card-container" id="investigationScoreCards"></div>
  </div>
</div>

  <!-- export button -->




  <!-- Altına chart veya tablo geliyor olabilir -->



<!-- ✅ Alttaki Scorecard Satırı -->
<div class="row scorecard-row">
  <div class="card">
    <h2>Fraud Impact by Year</h2>
    <div class="score-card-container" id="investigationScoreCards2"></div>
  </div>


  <div class="card">
    <!-- placeholder veya gelecekteki kart getir githuba al -->
    <h2>Loss Prevention Impact by Year</h2>
    <div class="score-card-container" id="investigationScoreCards3"></div>
  </div>
</div>


<!-- ✅ Diğer her şey aşağıdan devam ediyor -->

  <div class="row">

<!-- ✅ OLMASI GEREKEN DOĞRU BLOK -->
<div class="card">
  <h2>Audit Findings by Year and Status</h2>
  <div class="filter-row">
    <div class="filter-group">
      <!-- 1. Etiket düzeltildi (for="auditTypeSelect") -->
      <label for="auditTypeSelect" style="font-size: 14px; font-weight: 500;">Filter:</label>
      <!-- 2. ID düzeltildi (id="auditTypeSelect"), inline stiller korundu -->
      <select id="auditTypeSelect" onchange="reloadBarChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
        <!-- Bu kısım JavaScript tarafından doldurulacak -->
      </select>
    </div>
  </div>
  <canvas id="statusChart"></canvas>
</div>

    <div class="card" style="max-width: 1000px;">
      <h2>Finding Actions - Status Distribution</h2>
      <div style="display: flex; flex-wrap: nowrap; gap: 24px; align-items: flex-start; width: 100%;">
        <div style="flex: 1; min-width: 300px; max-width: 400px;">
          <div style="margin-bottom: 10px;">
            <label for="auditTypeSelectActionPie" style="font-size: 14px; font-weight: 500;">Filter:</label>
            <select id="auditTypeSelectActionPie" onchange="reloadActionPieChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
              <option value="">All Types</option>
            </select>
          </div>
          <canvas id="actionPie" width="280" height="280"></canvas>
          <div class="legend" id="actionLegend"></div>
        </div>
        <div class="audit-table-wrapper">
          <div id="auditNameStatusTableContainer"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Finding Actions by Lead and Status</h2>
      <canvas id="leadStatusChart"></canvas>
    </div>

    <div class="card">
      <h2>Audit Plan - Progress Tracker</h2>
      <div style="align-self: flex-end; margin-bottom: 10px;">
        <label for="auditLeadSelect" style="font-size: 14px; font-weight: 500;">Audit Lead:</label>
        <select id="auditLeadSelect" onchange="loadAuditProgressChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
          <option value="">All Leads</option>
        </select>
        <label for="auditYearSelect" style="font-size: 14px; font-weight: 500; margin-left: 20px;">Audit Year:</label>
        <select id="auditYearSelect" onchange="loadAuditProgressChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
          <option value="">All Years</option>
        </select>
      </div>
      <div id="auditProgressWrapper">
        <canvas id="auditProgressChart"></canvas>
      </div>
    </div>
  <div class="card">
  <div class="card-header">
    <h2>Finding Actions Aging</h2>
    <button id="exportFindingActionsBtn" class="btn-export">Export to Excel</button>
  </div>

  <div style="align-self: flex-end; margin-bottom: 10px;">
    <label for="auditLeadSelectAge" style="font-size: 14px; font-weight: 500;">Audit Lead:</label>
    <select id="auditLeadSelectAge" onchange="loadLeadActionAgeChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
      <option value="">All Leads</option>
    </select>
  </div>

  <canvas id="leadActionAgeChart"></canvas>
</div>


    <div class="card">
      <h2>Risk Level Distribution by Audit Project</h2>
      <div id="projectRiskTableContainer"></div>
    </div>

    <div class="card compact-table-card">
      <h2>Finding Distribution by Internal Control Element and Risk Level</h2>
      <div id="controlRiskTableContainer"></div>
    </div>

    <div class="card compact-table-card">
      <h2>Finding Distribution by Risk Type and Risk Level</h2>
      <div id="typeRiskTableContainer"></div>
    </div>

<div class="card compact-table-card">
  <h2>Fraud Impact</h2>
  <div id="fraudImpactTableContainer"></div>
  </div>
<div class="card compact-table-card">
  <h2>Loss Prevention Impact</h2>
  <div id="lossPreventionSummaryContainer"></div>
</div>



  </div> <!-- row -->
</div> <!-- container -->

</div>
    <!-- Metin Görünümü Alt Kart -->

<!-- 📦 1. XLSX kütüphanesini yükle -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- 🧠 2. Kendi scriptini ayrı yaz -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const exportBtn = document.getElementById('exportFindingActionsBtn');
  if (!exportBtn) {
    console.error("Export butonu DOM'da bulunamadı.");
    return;
  }

  exportBtn.addEventListener('click', async () => {
    console.log("Export to Excel butonuna tıklandı."); // ✅ Takip logu

    try {
      const response = await fetch(`${backendURL}/api/finding-actions-export`, { credentials: 'include' });
      const data = await response.json();


      if (!Array.isArray(data) || data.length === 0) {
        alert("No data found for export.");
        return;
      }

      // ADF (Atlassian Document Format) içeriğini düz metne çeviren fonksiyon
      function extractTextFromADF(adf) {
        if (!adf || typeof adf !== 'object') return '';
        if (adf.type === 'text') return adf.text || '';
        if (!Array.isArray(adf.content)) return '';
        return adf.content.map(extractTextFromADF).join(' ');
      }

      // Veriyi dönüştür (ADF formatındaki alanları temizle)
      const cleanedData = data.map(item => ({
        ...item,
        description: extractTextFromADF(item.description),
        actionDescription: extractTextFromADF(item.actionDescription)
      }));

      const worksheet = XLSX.utils.json_to_sheet(cleanedData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "FindingActions");

      XLSX.writeFile(workbook, "finding-actions.xlsx");
      console.log("Excel dosyası indiriliyor...");

    } catch (err) {
      console.error("Excel export error:", err);
      alert("An error occurred while exporting to Excel.");
    }
  });
});
</script>

  <script>
 const backendURL = 'https://exe-dash-backend.onrender.com';

const predefinedColors = {
  'OPEN': '#2980b9',
  'COMPLETED': '#27ae60',
  'CLOSED': '#e67e22',
  'RISK ACCEPTED': '#8e44ad'
};

const fallbackColors = ['#7f8c8d', '#34495e', '#f39c12', '#95a5a6'];
const statusColors = {};
let colorIndex = 0;
let barChartInstance = null;

// ✅ OLMASI GEREKEN DOĞRU FONKSİYON
function loadAuditTypes() {
  fetch(`${backendURL}/api/audit-types`, { credentials: 'include' })
    .then(res => res.json())
    .then(types => {
      const barSelect = document.getElementById('auditTypeSelect');
      const actionSelect = document.getElementById('auditTypeSelectActionPie');

      if (barSelect) {
        barSelect.innerHTML = '<option value="">All Types</option>';
        types.forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          barSelect.appendChild(option);
        });
      }

      if (actionSelect) {
        actionSelect.innerHTML = '<option value="">All Types</option>';
        types.forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          actionSelect.appendChild(option);
        });
      }

      // "new Choices" ile başlayan blok buradan silindiği için
      // 'auditTypeSelect' filtresinin tasarımı artık değişmeyecek.

      reloadBarChart();
      reloadActionPieChart();
    });
}
function toTitleCase(str) {
  if (!str) return '';
  return str.toLowerCase().split(' ').map(function(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
  }).join(' ');
}



function reloadBarChart() {
 const selectedAuditTypeOptions = Array.from(document.getElementById('auditTypeSelect')?.selectedOptions || []);
 const selectedAuditTypes = selectedAuditTypeOptions.map(opt => opt.value).filter(v => v !== "");

 const params = new URLSearchParams();
 selectedAuditTypes.forEach(type => params.append('auditTypes', type));

 const url = `${backendURL}/api/finding-status-by-year?${params.toString()}`;

 fetch(url, { credentials: 'include' })
  .then(res => res.json())
  .then(data => {
   const years = Object.keys(data).filter(y => y !== 'Unknown').sort();
   if (Object.keys(data).includes('Unknown')) {
    years.push('Unknown');
   }
   const allStatusesSet = new Set();
   years.forEach(year => {
    Object.keys(data[year]).forEach(status => allStatusesSet.add(status));
   });
   const allStatuses = Array.from(allStatusesSet);
   allStatuses.forEach(status => {
    const normalized = status.toUpperCase();
    if (!statusColors[status]) {
     statusColors[status] = predefinedColors[normalized] || fallbackColors[colorIndex++ % fallbackColors.length];
    }
   });
      // ✨ DEĞİŞİKLİK BURADA ✨
   const datasets = allStatuses.map(status => {
    const dataPoints = years.map(year => data[year][status] || 0);
    return {
     label: toTitleCase(status), // status'ü yeni fonksiyonumuzla formatlıyoruz
     data: dataPoints,
     backgroundColor: statusColors[status],
     borderRadius: 6
    };
   });
   const config = {
    type: 'bar',
    data: {
     labels: years.map(y => y === 'Unknown' ? 'Not Assigned' : y),
     datasets
    },
    options: {
     responsive: true,
     plugins: {
      legend: { position: 'top' },
      datalabels: { display: false }
     },
     scales: {
      x: { stacked: true },
      y: { stacked: true, beginAtZero: true }
     }
    },
    plugins: [ChartDataLabels]
   };
   if (barChartInstance) {
    barChartInstance.destroy();
   }
   barChartInstance = new Chart(document.getElementById('statusChart').getContext('2d'), config);
  });
}

// Sayfa yüklendiğinde sadece dropdown'u yükle
function initializeDashboard() {
  loadAuditTypes();
  reloadBarChart();
  // reloadPieChart(); // SİLİNDİ
  reloadActionPieChart();
  loadLeadStatusChart();
  loadAuditProgressChart();
  loadLeadActionAgeChart();
  loadInvestigationScores();
  loadFraudImpactScoreCards();
  loadLpImpactScoreCards();
  loadAuditNameStatusTable();
  loadProjectRiskChart();
  loadAuditProjectScoreCards();
  loadGoogleSheetTable();
  loadLossPreventionSummary();
  document.getElementById('auditLeadSelectAge').addEventListener('change', loadLeadActionAgeChart);
}








function reloadActionPieChart() {
  const selectedAuditType = document.getElementById('auditTypeSelectActionPie')?.value;

  let url = `${backendURL}/api/finding-action-status-distribution`;
  const params = [];

  if (selectedAuditType) params.push(`auditTypes=${encodeURIComponent(selectedAuditType)}`);
  if (params.length > 0) url += '?' + params.join('&');

  fetch(url, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);

      const backgroundColors = labels.map(label => {
        const upper = label.toUpperCase();
        if (upper === 'OVERDUE') return '#e74c3c'; // kırmızı
        if (upper === 'DELAYED') return '#581845'; // koyu bordo
        return predefinedColors[upper] || fallbackColors[colorIndex++ % fallbackColors.length];
      });

      if (actionPieChartInstance) actionPieChartInstance.destroy();

      actionPieChartInstance = new Chart(document.getElementById('actionPie').getContext('2d'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: backgroundColors,
            borderColor: '#f5f7fa',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const total = values.reduce((a, b) => a + b, 0);
      const legendEl = document.getElementById('actionLegend');
      legendEl.innerHTML = `<strong>Total Actions:</strong> ${total}<br><br>`;
      labels.forEach((label, i) => {
        legendEl.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:6px;">
            <div style="width:14px;height:14px;background:${backgroundColors[i]};margin-right:10px;border-radius:3px;"></div>
            ${label}: <strong style="margin-left:5px;">${values[i]}</strong>
          </div>`;
      });
    });
}

let leadStatusChartInstance = null;

function loadLeadStatusChart() {
  fetch(`${backendURL}/api/finding-action-status-by-lead`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const leads = Object.keys(data);
      const statusesSet = new Set();

      leads.forEach(lead => {
        Object.keys(data[lead]).forEach(status => statusesSet.add(status));
      });

      const statuses = Array.from(statusesSet);
      statuses.forEach(status => {
        if (!statusColors[status]) {
          statusColors[status] = predefinedColors[status.toUpperCase()] || fallbackColors[colorIndex++ % fallbackColors.length];
        }
      });

      // ✨ DEĞİŞİKLİK BURADA ✨
      const datasets = statuses.map(status => {
        return {
          label: toTitleCase(status), // status'ü yeni fonksiyonumuzla formatlıyoruz
          data: leads.map(lead => data[lead][status] || 0),
          backgroundColor: statusColors[status],
          borderRadius: 6
        };
      });

      const config = {
        type: 'bar',
        data: {
          labels: leads,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            datalabels: { display: false }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        },
        plugins: [ChartDataLabels]
      };

      if (leadStatusChartInstance) leadStatusChartInstance.destroy();
      leadStatusChartInstance = new Chart(document.getElementById('leadStatusChart').getContext('2d'), config);
    });
}

        // Two Dimensional Table
        fetch(`${backendURL}/api/statistics-by-control-and-risk`, { credentials: 'include' })
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById('controlRiskTableContainer');
            const riskLevels = ['Critical', 'High', 'Medium', 'Low'];
            const headers = ['Internal Control Element', ...riskLevels, 'T:'];
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            data.forEach(row => {
              html += '<tr>';
              html += `<td>${row.control}</td>`;
              riskLevels.forEach(level => {
                const count = row[level] || 0;
                if (count > 0 && row.control !== 'Total Unique Issues:') {
                  html += `<td style="cursor:pointer;text-decoration:underline;" onclick="showDetails('${row.control}', '${level}')">${count}</td>`;
                } else {
                  html += `<td>${count}</td>`;
                }
              });
              html += `<td>${row.Total}</td>`;
              html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
          });


fetch(`${backendURL}/api/statistics-by-type-and-risk`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('typeRiskTableContainer');
      const riskLevels = ['Critical', 'High', 'Medium', 'Low'];
      const headers = ['Risk Type', ...riskLevels, 'T:'];
      let html = '<table><thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
    data.forEach(row => {
  html += '<tr>';
  html += `<td>${row.type}</td>`;
  riskLevels.forEach(level => {
    const count = row[level] || 0;
    if (count > 0 && row.type !== 'Total Unique Issues:') {
      html += `<td style="cursor:pointer;text-decoration:underline;" onclick="showDetails('${row.type}', '${level}', 'type')">${count}</td>`;
    } else {
      html += `<td>${count}</td>`;
    }
  });
  html += `<td>${row.Total}</td>`;
  html += '</tr>';
});

      html += '</tbody></table>';
      container.innerHTML = html;
    });

  function showDetails(control, risk, mode = 'control') {
  const title = `${control} – ${risk} Risk Findings`;
  document.getElementById('detailTitle').innerText = title;
  document.getElementById('detailList').innerHTML = '<li>Loading...</li>';
  document.getElementById('detailBox').style.display = 'block';

  const url = mode === 'control'
    ? `${backendURL}/api/finding-details-by-control-and-risk?control=${encodeURIComponent(control)}&risk=${encodeURIComponent(risk)}`
    : `${backendURL}/api/finding-details-by-type-and-risk?type=${encodeURIComponent(control)}&risk=${encodeURIComponent(risk)}`;

  fetch(url, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('detailList');
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = '<li>No findings found.</li>';
      } else {
        data.forEach(issue => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="https://getir.atlassian.net/browse/${issue.key}" target="_blank">${issue.key}</a>: ${issue.summary}`;
          list.appendChild(li);
        });
      }
    });
}

     function showDetailsByYearAndStatus(year, status) {
  const title = `${status} Findings${year !== 'all' ? ' in ' + year : ''}`;
  document.getElementById('detailTitle').innerText = title;
  document.getElementById('detailList').innerHTML = '<li>Loading...</li>';
  document.getElementById('detailBox').style.display = 'block';

  fetch(`${backendURL}/api/finding-details?year=${encodeURIComponent(year)}&status=${encodeURIComponent(status)}`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('detailList');
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = '<li>No findings found.</li>';
      } else {
        data.forEach(issue => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="https://getir.atlassian.net/browse/${issue.key}" target="_blank">${issue.key}</a>: ${issue.summary}`;
          list.appendChild(li);
        });
      }
    });
}

// ✅ Bu satırı EKLE:
window.showDetailsByYearAndStatus = showDetailsByYearAndStatus;
let actionPieChartInstance = null;

function loadActionPieChart() {
  const selectedAuditType = document.getElementById('auditTypeSelectActionPie')?.value;

  let url = `${backendURL}/api/finding-action-status-distribution`;
  const params = [];

  if (selectedAuditType) params.push(`auditTypes=${encodeURIComponent(selectedAuditType)}`);
  if (params.length > 0) url += '?' + params.join('&');

  fetch(url, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);

      const backgroundColors = labels.map(label => {
        const upper = label.toUpperCase();
        if (upper === 'OVERDUE') return '#e74c3c'; // kırmızı
        if (upper === 'DELAYED') return '#581845'; // koyu bordo
        return predefinedColors[upper] || fallbackColors[colorIndex++ % fallbackColors.length];
      });

      if (actionPieChartInstance) actionPieChartInstance.destroy();

      actionPieChartInstance = new Chart(document.getElementById('actionPie').getContext('2d'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: backgroundColors,
            borderColor: '#f5f7fa',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const total = values.reduce((a, b) => a + b, 0);
      const legendEl = document.getElementById('actionLegend');
      legendEl.innerHTML = `<strong>Total Actions:</strong> ${total}<br><br>`;
      labels.forEach((label, i) => {
        legendEl.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:6px;">
            <div style="width:14px;height:14px;background:${backgroundColors[i]};margin-right:10px;border-radius:3px;"></div>
            ${label}: <strong style="margin-left:5px;">${values[i]}</strong>
          </div>`;
      });
    });
}

let auditProgressChartInstance = null;
let auditProgressDropdownsInitialized = false;

function loadAuditProgressChart() {
  let selectedLead = document.getElementById('auditLeadSelect')?.value;
  let selectedYear = document.getElementById('auditYearSelect')?.value;

  if (!selectedYear && !auditProgressDropdownsInitialized) {
    selectedYear = '2025';
  }

  fetch(`${backendURL}/api/yearly-audit-plan`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const leads = new Set();
      const years = new Set();

      const filteredData = data
        .filter(d => {
          leads.add(d.auditLead);
          years.add(d.auditYear);
          return (!selectedLead || d.auditLead === selectedLead) &&
                 (!selectedYear || d.auditYear === selectedYear);
        })
        .sort((a, b) => b.progressLevel - a.progressLevel);

      const sortedLeads = Array.from(leads).sort();
      const sortedYears = Array.from(years).sort();

      const leadSelect = document.getElementById('auditLeadSelect');
      const yearSelect = document.getElementById('auditYearSelect');

      if (!auditProgressDropdownsInitialized) {
        leadSelect.innerHTML = '<option value="">All Leads</option>' +
          sortedLeads.map(l => `<option value="${l}">${l}</option>`).join('');
        yearSelect.innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
        leadSelect.value = selectedLead;
        yearSelect.value = selectedYear;
        auditProgressDropdownsInitialized = true;
      }

      // ✔️ Canvas yüksekliği dinamik ayarlanıyor
      const chartCanvas = document.getElementById('auditProgressChart');
      const chartWrapper = document.getElementById('auditProgressWrapper');
      const chartHeight = filteredData.length * 40;
      chartCanvas.height = chartHeight;
  chartCanvas.height = filteredData.length * 40;


      const allStages = ['Planned', 'Fieldwork', 'Pre Closing', 'Closing', 'Completed'];
      const greyColor = '#ecf0f1';
      const greenColor = '#27ae60';
      const segmentValue = 1 / allStages.length;

      const datasets = allStages.map((stage, idx) => ({
        label: stage,
        data: filteredData.map(() => segmentValue),
        backgroundColor: filteredData.map(d => d.progressLevel > idx ? greenColor : greyColor),
        stack: 'same',
        datalabels: {
          display: true,
          formatter: () => stage,
          color: (ctx) => ctx.dataset.backgroundColor[ctx.dataIndex] === greyColor ? '#7f8c8d' : '#ffffff',
          font: { weight: 'normal', size: 10 },
          anchor: 'center',
          align: 'center',

        },
        borderRadius: 4,
        borderSkipped: false,
        barThickness: 12
      }));

      const ctx = chartCanvas.getContext('2d');
      if (auditProgressChartInstance) auditProgressChartInstance.destroy();

      auditProgressChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: filteredData.map(d => d.summary),
          datasets
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false, // 🔑 Canvas'ın aspect ratio zorlamaması için
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { min: 0, max: 1, display: false },
            y: {
              ticks: {
                font: { size: 12, weight: '500' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    });
}





let leadActionAgeChartInstance = null;
// Not: leadAgeChartChoices değişkeni silindi.

function loadLeadActionAgeChart() {
  const select = document.getElementById('auditLeadSelectAge');
  const selectedLead = select ? select.value : '';
  console.log("SEÇİLEN LEAD:", selectedLead);

  if (select && select.options.length <= 1) {
    fetch(`${backendURL}/api/finding-action-status-by-lead`, { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        const leads = Object.keys(data).sort();
        leads
          .filter(lead => lead && lead.trim() !== '')
          .forEach(lead => {
            const option = document.createElement('option');
            option.value = lead;
            option.textContent = lead;
            select.appendChild(option);
          });
          // Choices.js başlatma kodu buradan kaldırıldı.
      });
  }

  const query = selectedLead ? `?lead=${encodeURIComponent(selectedLead)}` : '';
  const baseURL = `${backendURL}/api`;

  const urls = [
    `${baseURL}/finding-action-age-summary${query}`,
    `${baseURL}/finding-action-age-summary-delayed${query}`
  ];

  Promise.all(urls.map(url => fetch(url, { credentials: 'include' }).then(res => res.json())))
    .then(([openData, delayedData]) => {
      const labels = [
        '-720–-360', '-360–-180', '-180–-90', '-90–-30', '-30–0',
        '0–30', '30–90', '90–180', '180–360', '360–720', '720+'
      ];
      const backgroundColors = [
        '#95a5a6', '#7f8c8d', '#bdc3c7', '#ecf0f1', '#f39c12',
        '#27ae60', '#f1c40f', '#e67e22', '#d35400', '#c0392b', '#8e44ad'
      ];
      const combinedValues = labels.map(label => (openData[label] || 0) + (delayedData[label] || 0));
      const config = {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Number of Actions',
            data: combinedValues,
            backgroundColor: backgroundColors,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: { display: false }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { maxRotation: 90, minRotation: 90, align: 'center' }
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      };
      if (leadActionAgeChartInstance) leadActionAgeChartInstance.destroy();
      leadActionAgeChartInstance = new Chart(
        document.getElementById('leadActionAgeChart').getContext('2d'),
        config
      );
    })
    .catch(err => console.error('Error loading combined action age chart:', err));
}


async function loadProjectRiskChart() {
  try {
    const response = await fetch(`${backendURL}/api/finding-risk-distribution-by-project`, { credentials: 'include' });
    const data = await response.json();

    const container = document.getElementById('projectRiskTableContainer');
    const riskLevels = ['Critical', 'High', 'Medium', 'Low'];

    // 👇 Audit Year kolonu eklendi
    const headers = ['Audit Project', 'Audit Year', ...riskLevels, 'T:'];

    let html = '<table><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      html += '<tr>';
      html += `<td>${row.project}</td>`;      // Audit Project
      html += `<td>${row.year}</td>`;         // 👈 Audit Year buraya eklendi

      let total = 0;
      riskLevels.forEach(level => {
        const count = row[level] || 0;
        total += count;
        html += `<td>${count}</td>`;
      });

      html += `<td>${total}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Failed to load project risk table:', error);
  }
}

async function loadAuditNameStatusTable() {
  try {
    const response = await fetch(`${backendURL}/api/finding-actions-by-audit-name-and-status`, { credentials: 'include' });
    const data = await response.json();

    const container = document.getElementById('auditNameStatusTableContainer');
    const allStatuses = new Set();

    // Tüm unique status'ları topla
    data.forEach(row => {
      Object.keys(row).forEach(key => {
        if (!['auditName', 'auditYear'].includes(key)) {
          allStatuses.add(key);
        }
      });
    });

    const sortedStatuses = Array.from(allStatuses).sort();
    const headers = ['Audit Name', 'Audit Year', ...sortedStatuses, 'T:'];

    // ✅ Audit Year'a göre büyükten küçüğe sırala
    data.sort((a, b) => {
      const yearA = typeof a.auditYear === 'object' ? parseInt(a.auditYear?.value) : parseInt(a.auditYear);
      const yearB = typeof b.auditYear === 'object' ? parseInt(b.auditYear?.value) : parseInt(b.auditYear);
      if (isNaN(yearA)) return 1;
      if (isNaN(yearB)) return -1;
      return yearB - yearA;
    });

    let html = '<table><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      let total = 0;
      const year = typeof row.auditYear === 'object' ? row.auditYear?.value || 'Unknown' : row.auditYear || 'Unknown';
      html += `<tr><td>${row.auditName}</td><td>${year}</td>`;
      sortedStatuses.forEach(status => {
        const count = row[status] || 0;
        html += `<td>${count}</td>`;
        total += count;
      });
      html += `<td>${total}</td></tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Failed to load audit name status table:', error);
  }
}





async function loadFraudImpactScoreCards() {
  try {
    const response = await fetch(`${backendURL}/api/fraud-impact-score-cards`, { credentials: 'include' });
    const data = await response.json();

    const scoreCards = data.scoreCards;
    console.log("Fraud Impact API Response:", scoreCards);

    const container = document.getElementById('investigationScoreCards2');
    container.innerHTML = '';

    const auditorCountPerYear = {
      "2021": 2.45,
      "2022": 6.03,
      "2023": 4.49,
      "2024": 1.73,
      "2025": 0.77
    };

    // Yıllara göre sırala (küçükten büyüğe)
    scoreCards.sort((a, b) => parseInt(b.year) - parseInt(a.year));


    scoreCards.forEach(item => {
      const year = item.year.toString();

      // Virgülleri kaldır ve sayıya çevir
      const rawImpact = item.impact.replace(/,/g, '');
      const totalImpact = parseFloat(rawImpact) || 0;

      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = totalImpact / auditors;

      // Kısa gösterim: milyon formatı
      const formattedImpact = `€${(totalImpact / 1_000_000).toFixed(2)}M`;
      const formattedPerAuditor = `€${(perAuditor / 1_000_000).toFixed(2)}M`;

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${formattedImpact}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${formattedPerAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load fraud impact score cards:", error);
  }
}

async function loadLpImpactScoreCards() {
  try {
    const response = await fetch(`${backendURL}/api/lp-impact-score-cards`, { credentials: 'include' });
    const data = await response.json();

    const scoreCards = data.scoreCards;
    console.log("Fraud Impact API Response:", scoreCards);

    const container = document.getElementById('investigationScoreCards3');
    container.innerHTML = '';

    const auditorCountPerYear = {
      "2021": 2.70,
      "2022": 6.45,
      "2023": 5.33,
      "2024": 4.40,
      "2025": 1.31
    };

    // Yıllara göre sırala (küçükten büyüğe)
    scoreCards.sort((a, b) => parseInt(b.year) - parseInt(a.year));


    scoreCards.forEach(item => {
      const year = item.year.toString();

      // Virgülleri kaldır ve sayıya çevir
      const rawImpact = item.impact.replace(/,/g, '');
      const totalImpact = parseFloat(rawImpact) || 0;

      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = totalImpact / auditors;

      // Kısa gösterim: milyon formatı
      const formattedImpact = `€${(totalImpact / 1_000_000).toFixed(2)}M`;
      const formattedPerAuditor = `€${(perAuditor / 1_000_000).toFixed(2)}M`;

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${formattedImpact}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${formattedPerAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load loss prevention impact score cards:", error);
  }
}


async function loadInvestigationScores() {
  try {
    const res = await fetch(`${backendURL}/api/investigation-counts`, { credentials: 'include' });
    const data = await res.json();
    console.log("Investigation API Response:", data);

    const container = document.getElementById('investigationScoreCards');
    container.innerHTML = '';

    const grouped = {};
    const auditorCountPerYear = {
      "2020": 0.30,
      "2021": 1.87,
      "2022": 3.01,
      "2023": 3.12,
      "2024": 2.44,
      "2025": 0.83
    };

    data.forEach(item => {
      if (!grouped[item.year]) grouped[item.year] = 0;
      grouped[item.year] += item.count;
    });

    const years = Object.keys(grouped).sort().reverse();

    years.forEach(year => {
      const total = grouped[year];
      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = (total / auditors).toFixed(2);

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${total}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${perAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load investigation scores:", error);
  }
}

async function loadGoogleSheetTable() {
  try {
    const res = await fetch(`${backendURL}/api/google-sheet-data`, { credentials: 'include' });
    const data = await res.json();

    const rows = data.result;
    if (!Array.isArray(rows) || rows.length === 0) return;

    const container = document.getElementById("fraudImpactTableContainer");

    let html = '<table class="compact-table"><thead><tr>';
    rows[0].forEach(cell => {
      html += `<th>${cell}</th>`;
    });
    html += '</tr></thead><tbody>';

    for (let i = 1; i < rows.length; i++) {
      html += '<tr>';
      rows[i].forEach(cell => {
        html += `<td>${cell || ''}</td>`;
      });
      html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (err) {
    console.error("Failed to load Google Sheet data:", err);
  }
}


async function loadAuditProjectScoreCards() {
  try {
    const res = await fetch(`${backendURL}/api/audit-projects-by-year`, { credentials: 'include' });
    const data = await res.json();

    const container = document.getElementById('auditProjectScoreCards');
    container.innerHTML = '';

    const auditorCountPerYear = {
      "2020": 1.60,
      "2021": 5.15,
      "2022": 13.09,
      "2023": 13.98,
      "2024": 6.51,
      "2025": 1.85
    };

    const countsPerYear = {};

    data.forEach(item => {
      const year = item.auditYear || 'Unknown';
      const count = item.count || 0;
      countsPerYear[year] = count;
    });

    const years = Object.keys(countsPerYear).sort().reverse();

    years.forEach(year => {
      const totalProjects = countsPerYear[year];
      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = (totalProjects / auditors).toFixed(2);

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${totalProjects}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${perAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load audit project scorecards:", error);
  }
}


async function loadLossPreventionSummary() {
  try {
    const response = await fetch('https://exe-dash-backend.onrender.com/api/loss-prevention-summary' , { credentials: 'include' });
    const data = await response.json();
    const rows = data.result;

    if (!rows || rows.length === 0) {
      throw new Error("No data received");
    }

    const container = document.getElementById('lossPreventionSummaryContainer');

    const table = document.createElement('table');
    table.classList.add('compact-table');

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    rows[0].forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // 🔽 Başlık satırını atla (index 1'den başla)
    for (let i = 1; i < rows.length; i++) {
      const tr = document.createElement('tr');
      rows[i].forEach((cell, j) => {
        const td = document.createElement('td');
        td.textContent = cell;
        if (j === 0) td.style.textAlign = 'left';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    container.innerHTML = ''; // Önceki içeriği temizle
    container.appendChild(table);
  } catch (error) {
    console.error('Loss Prevention API error:', error);
    document.getElementById('lossPreventionSummaryContainer').innerText = 'Failed to load data.';
  }
}
</script>
</body>
</html>
