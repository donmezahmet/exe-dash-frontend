<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Findings Executive Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Choices.js CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<!-- Choices.js JS -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
    }

    header {
      background-color: #2c3e50;
      color: white;
      padding: 16px 40px;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 40px;
      padding: 40px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      width: 100%;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
      flex: 1 1 600px;
      max-width: 650px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

  .card-full {
  max-width: 100% !important;
  flex: 1 1 100% !important;
}


    h2 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    canvas {
      width: 100% !important;
      max-height: 360px !important;
    }

    .dropdown-multiselect {
  width: 100%;
  margin-bottom: 12px;
}

select[multiple] {
  width: 70%;
  max-height: 42px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

.choices__list--multiple {
  display: flex !important;
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  padding: 4px 0;
  margin: 0;
  width: 100%;
}



.choices[data-type*="select-multiple"] .choices__list--dropdown {
  width: auto !important;
  min-width: 300px !important;
}
.choices__item .choices__button {
  margin-left: 8px;
  color: #fff;
  font-weight: bold;
  font-size: 12px;
}
.choices__list--multiple .choices__item {
  background-color: #007b8a;
  color: #fff;
  border-radius: 20px;
  padding: 5px 10px;
  margin: 0 6px 0 0; /* üstten boşluk kaldırıldı */
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  white-space: nowrap; /* ✅ Taşmayı engeller */
}



.choices__inner {
  max-height: 44px !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  display: flex !important;
  flex-wrap: nowrap !important;
  align-items: center;
}

    #riskTextChart {
      width: 100%;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      color: #2c3e50;
    }

    .legend {
      margin-top: 10px;
      width: 100%;
      font-size: 14px;
    }

     #controlRiskTableContainer {
    width: 100%;
    overflow-x: auto;
  }

  #controlRiskTableContainer table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    background-color: #1c1f26;
    color: #e0e6f0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
  }

  #controlRiskTableContainer th,
  #controlRiskTableContainer td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid #2f3640;
    word-break: break-word;
  }

  #controlRiskTableContainer th {
    background-color: #2f3640;
    font-weight: 600;
    color: #dcdde1;
  }

  #controlRiskTableContainer td {
    color: #3498db;
  }

  #controlRiskTableContainer tr:last-child {
    font-weight: bold;
    background-color: #1e272e;
    border-top: 2px solid #57606f;
  }


   #typeRiskTableContainer {
    width: 100%;
    overflow-x: auto;
  }

  #typeRiskTableContainer table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    background-color: #1c1f26;
    color: #e0e6f0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
  }

  #typeRiskTableContainer th,
  #typeRiskTableContainer td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid #2f3640;
    word-break: break-word;
  }

  #typeRiskTableContainer th {
    background-color: #2f3640;
    font-weight: 600;
    color: #dcdde1;
  }

  #typeRiskTableContainer td {
    color: #3498db;
  }

  #typeRiskTableContainer tr:last-child {
    font-weight: bold;
    background-color: #1e272e;
    border-top: 2px solid #57606f;
  }
  .filter-row {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group label {
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 6px;
}

.filter-group .choices {
  width: 100%;
  max-width: 300px;
}





    #detailBox {
      display: none;
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
      border-radius: 10px;
    }

    #detailBox button {
      float: right;
    }

    #detailBox h3 {
      margin-top: 0;
    }

    #detailBox ul {
      padding-left: 20px;
    }

    #detailBox li {
      margin-bottom: 6px;
    }

    .score-card-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: flex-start;
}

.score-card {
  background-color: #1c1f26;
  color: #ecf0f1;
  border-radius: 12px;
  padding: 20px 30px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  text-align: center;
  min-width: 120px;
  flex: 1 0 120px;
}

.score-card h3 {
  font-size: 20px;
  margin: 0;
  color: #3498db;
}

.score-card p {
  font-size: 14px;
  margin: 6px 0 4px;
  color: #95a5a6;
}

.score-card .count {
  font-size: 28px;
  font-weight: bold;
  color: #2ecc71;
}
#projectRiskTableContainer {
  width: 100%;
  max-height: 400px;
  overflow-y: auto;
  overflow-x: auto;
}

#projectRiskTableContainer table {
  width: 100%;
  table-layout: fixed;
  border-collapse: collapse;
  background-color: #1c1f26;
  color: #e0e6f0;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
}

#projectRiskTableContainer th,
#projectRiskTableContainer td {
  padding: 6px 8px;
  text-align: left;
  border: 1px solid #2f3640; /* ✅ Hücre çerçeveleri */
  word-break: break-word;
   min-height: 10px;
}

#projectRiskTableContainer th {
  background-color: #2f3640;
  font-weight: 600;
  color: #dcdde1;
}

#projectRiskTableContainer tr {
  border-bottom: 1px solid #444; /* ✅ Satır ayraç çizgisi */
}

#projectRiskTableContainer tr:last-child {
  font-weight: bold;
  background-color: #1e272e;
  border-top: 2px solid #57606f;
}

@media (max-width: 1000px) {
  .card {
    max-width: 100%;
  }
}

#auditNameStatusTableContainer {
  width: 100%;
  max-height: 400px;
  overflow-y: auto;
  overflow-x: auto;
}

#auditNameStatusTableContainer table {
  width: max-content;
  min-width: 650px;
  border-collapse: collapse;
  background-color: #1c1f26;
  color: #e0e6f0;
  font-family: 'Segoe UI', sans-serif;
  font-size: 12px;
}

#auditNameStatusTableContainer th,
#auditNameStatusTableContainer td {
  padding: 6px 10px;
  text-align: center;
  border: 1px solid #2f3640;
  word-break: break-word;
}
#auditNameStatusTableContainer th:first-child,
#auditNameStatusTableContainer td:first-child {
  max-width: 180px;
  width: 180px;
  text-align: left;
  white-space: normal;
  word-break: break-word;
}


#auditNameStatusTableContainer th {
  background-color: #2f3640;
  font-weight: 600;
  color: #dcdde1;
  white-space: nowrap;
}

#auditNameStatusTableContainer tr:last-child {
  font-weight: bold;
  background-color: #1e272e;
  border-top: 2px solid #57606f;
}

#auditProgressChart {
  display: block;
  max-height: 500px;
  overflow-y: auto;
}



  </style>
</head>
<body>
  <header>Audit Findings Executive Dashboard</header>

  <!-- Detay Kutusu -->
  <div id="detailBox">
    <button onclick="document.getElementById('detailBox').style.display='none'">Close</button>
    <h3 id="detailTitle"></h3>
    <ul id="detailList"></ul>
  </div>

  <div class="container">
    <!-- Üçlü Kart Satırı -->
    <div class="row">
      <div class="card">
<h2>Audit Findings by Year and Status</h2>
<div class="filter-row">
  <div class="filter-group">
    <label for="auditTypeSelect">Audit Type:</label>
    <select id="auditTypeSelect" multiple onchange="reloadBarChart()">
      <option value="">All Types</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="auditCountrySelect">Country:</label>
    <select id="auditCountrySelect" multiple onchange="reloadBarChart()">
      <option value="">All Countries</option>
    </select>
  </div>
</div>
<canvas id="statusChart"></canvas>
      </div>

      <div class="card">
   <h2>Audit Findings - Status Distribution</h2>
<div style="align-self: flex-end; margin-bottom: 10px;">
  <label for="auditTypeSelectPie" style="font-size: 14px; font-weight: 500;">Filter:</label>
  <select id="auditTypeSelectPie" onchange="reloadPieChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
    <option value="">All Types</option>
  </select>
  <label for="auditCountrySelectPie" style="font-size: 14px; font-weight: 500; margin-left: 20px;">Country:</label>
  <select id="auditCountrySelectPie" onchange="reloadPieChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
    <option value="">All Countries</option>
  </select>
</div>
        <canvas id="statusPie"></canvas>
        <div class="legend" id="statusLegend"></div>
      </div>
<!-- Bu dış card -->
<div class="card" style="max-width: 1000px;">
  <h2>Finding Actions - Status Distribution</h2>

  <div style="display: flex; flex-wrap: nowrap; gap: 24px; align-items: flex-start; width: 100%;">

    <!-- Pie Chart Alanı -->
    <div style="flex: 1; min-width: 300px; max-width: 400px;">
      <div style="margin-bottom: 10px;">
        <label for="auditTypeSelectActionPie" style="font-size: 14px; font-weight: 500;">Filter:</label>
        <select id="auditTypeSelectActionPie" onchange="reloadActionPieChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
          <option value="">All Types</option>
        </select>
      </div>
      <canvas id="actionPie" width="280" height="280"></canvas>
      <div class="legend" id="actionLegend"></div>
    </div>

    <!-- Tablo Alanı -->
    <div style="flex: 2; overflow: auto; max-height: 400px;">
      <div id="auditNameStatusTableContainer"></div>
    </div>

  </div>
</div>




<!-- ✅ Yeni chart burada başlıyor -->
<div class="card">
  <h2>Finding Actions by Lead and Status</h2>
  <canvas id="leadStatusChart"></canvas>
</div>
<div class="card">
  <h2> Audit Plan - Progress Tracker</h2>
  <div style="align-self: flex-end; margin-bottom: 10px;">
    <label for="auditLeadSelect" style="font-size: 14px; font-weight: 500;">Audit Lead:</label>
    <select id="auditLeadSelect" onchange="loadAuditProgressChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
      <option value="">All Leads</option>
    </select>

    <label for="auditYearSelect" style="font-size: 14px; font-weight: 500; margin-left: 20px;">Audit Year:</label>
    <select id="auditYearSelect" onchange="loadAuditProgressChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
      <option value="">All Years</option>
    </select>
  </div>
 <canvas id="auditProgressChart" style="height: 900px;"></canvas>
</div>
<div class="card">
  <h2>Finding Actions Aging</h2>
  <div style="align-self: flex-end; margin-bottom: 10px;">
    <label for="auditLeadSelectAge" style="font-size: 14px; font-weight: 500;">Audit Lead:</label>
    <select id="auditLeadSelectAge" onchange="loadLeadActionAgeChart()" style="margin-left: 8px; padding: 4px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px;">
      <option value="">All Leads</option>
    </select>
  </div>
  <canvas id="leadActionAgeChart"></canvas>
</div>

<div class="card">
  <h2>Risk Level Distribution by Audit Project</h2>
<div id="projectRiskTableContainer"></div>
</div>
<div class="card">
  <h2>Audit Projects by Year</h2>
  <div class="score-card-container" id="auditProjectScoreCards"></div>
</div>

<div class="card">
  <h2>Investigations by Year</h2>
  <div class="score-card-container" id="investigationScoreCards"></div>
</div>



<!-- ✅ Yeni chart burada bitti -->

     <div class="row">
      <div class="card">
        <h2>Internal Control</h2>
        <div id="controlRiskTableContainer"></div>
      </div>
      <div class="card">
        <h2>Risk Type</h2>
        <div id="typeRiskTableContainer"></div>
      </div>

    </div>

    <!-- Metin Görünümü Alt Kart -->
    

  <script>
 const backendURL = 'https://exe-dash-backend.onrender.com';

const predefinedColors = {
  'OPEN': '#2980b9',
  'COMPLETED': '#27ae60',
  'CLOSED': '#e67e22',
  'RISK ACCEPTED': '#8e44ad'
};

const fallbackColors = ['#7f8c8d', '#34495e', '#f39c12', '#95a5a6'];
const statusColors = {};
let colorIndex = 0;
let barChartInstance = null;

function loadAuditTypes() {
  fetch(`${backendURL}/api/audit-types`)
    .then(res => res.json())
    .then(types => {
      const barSelect = document.getElementById('auditTypeSelect');
      const pieSelect = document.getElementById('auditTypeSelectPie');
      const actionSelect = document.getElementById('auditTypeSelectActionPie');

      barSelect.innerHTML = '<option value="">All Types</option>';
      pieSelect.innerHTML = '<option value="">All Types</option>';
      actionSelect.innerHTML = '<option value="">All Types</option>';

      types.forEach(type => {
        const option1 = document.createElement('option');
        option1.value = type;
        option1.textContent = type;
        barSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = type;
        option2.textContent = type;
        pieSelect.appendChild(option2);

        const option3 = document.createElement('option');
        option3.value = type;
        option3.textContent = type;
        actionSelect.appendChild(option3);
      });

      // ✅ Audit Type için Choices.js
      const auditTypeSelectEl = document.getElementById('auditTypeSelect');
      new Choices(auditTypeSelectEl, {
        removeItemButton: true,
        placeholder: true,
        placeholderValue: 'Select Audit Types',
        searchEnabled: true,
        shouldSort: false
      });

      // 🔽 Ülkeleri çek
      fetch(`${backendURL}/api/audit-countries`)
        .then(res => res.json())
        .then(countries => {
          const barCountrySelect = document.getElementById('auditCountrySelect');
          const pieCountrySelect = document.getElementById('auditCountrySelectPie');

          barCountrySelect.innerHTML = '<option value="">All Countries</option>';
          pieCountrySelect.innerHTML = '<option value="">All Countries</option>';

          countries.forEach(country => {
            const option1 = document.createElement('option');
            option1.value = country;
            option1.textContent = country;
            barCountrySelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = country;
            option2.textContent = country;
            pieCountrySelect.appendChild(option2);
          });

          // ✅ Country için Choices.js (çoklu seçimli)
          const auditCountrySelectEl = document.getElementById('auditCountrySelect');
          new Choices(auditCountrySelectEl, {
            removeItemButton: true,
            placeholder: true,
            placeholderValue: 'Select Countries',
            searchEnabled: true,
            shouldSort: false
          });

          // ✅ Grafikleri çiz
          reloadBarChart();
          reloadPieChart();
          reloadActionPieChart();
        });
    });
}

function reloadBarChart() {
  const selectedAuditTypeOptions = Array.from(document.getElementById('auditTypeSelect')?.selectedOptions || []);
  const selectedAuditTypes = selectedAuditTypeOptions.map(opt => opt.value).filter(v => v !== "");
  const selectedAuditCountry = document.getElementById('auditCountrySelect')?.value;

  const params = new URLSearchParams();
  selectedAuditTypes.forEach(type => params.append('auditTypes', type));
  if (selectedAuditCountry) params.append('auditCountries', selectedAuditCountry);

  const url = `${backendURL}/api/finding-status-by-year?${params.toString()}`;
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const years = Object.keys(data).filter(y => y !== 'Unknown').sort();
      if (Object.keys(data).includes('Unknown')) years.push('Unknown');

      const allStatusesSet = new Set();
      years.forEach(year => {
        Object.keys(data[year]).forEach(status => allStatusesSet.add(status));
      });

      const allStatuses = Array.from(allStatusesSet);

      allStatuses.forEach(status => {
        const normalized = status.toUpperCase();
        if (!statusColors[status]) {
          statusColors[status] = predefinedColors[normalized] || fallbackColors[colorIndex++ % fallbackColors.length];
        }
      });

      const datasets = allStatuses.map(status => {
        const dataPoints = years.map(year => data[year][status] || 0);
        return {
          label: status,
          data: dataPoints,
          backgroundColor: statusColors[status],
          borderRadius: 6
        };
      });

      const config = {
        type: 'bar',
        data: {
          labels: years.map(y => y === 'Unknown' ? 'Not Assigned' : y),
          datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            datalabels: { display: false }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        },
        plugins: [ChartDataLabels]
      };

      if (barChartInstance) barChartInstance.destroy();
      barChartInstance = new Chart(document.getElementById('statusChart').getContext('2d'), config);
    });
}

// Sayfa yüklendiğinde sadece dropdown'u yükle
window.onload = () => {
  loadAuditTypes();
  reloadBarChart();
  reloadPieChart();
  reloadActionPieChart();
  loadLeadStatusChart();
  loadAuditProgressChart();
  loadLeadActionAgeChart();
   loadInvestigationScores();
   loadAuditNameStatusTable();
  loadProjectRiskChart();
  loadAuditProjectScoreCards();
  document.getElementById('auditLeadSelectAge').addEventListener('change', loadLeadActionAgeChart);
};





let pieChartInstance = null;

function reloadPieChart() {
  const selectedAuditType = document.getElementById('auditTypeSelectPie')?.value;
  const selectedCountry = document.getElementById('auditCountrySelectPie')?.value;

  let url = `${backendURL}/api/finding-status-distribution`;
  const params = [];

  if (selectedAuditType) params.push(`auditTypes=${encodeURIComponent(selectedAuditType)}`);
  if (selectedCountry) params.push(`auditCountries=${encodeURIComponent(selectedCountry)}`);

  if (params.length > 0) {
    url += '?' + params.join('&');
  }

  const pieChartColors = {
    'OPEN': '#3498db',
    'COMPLETED': '#2ecc71',
    'CLOSED': '#e67e22',
    'RISK ACCEPTED': '#9b59b6'
  };

  fetch(url)
    .then(res => res.json())
    .then(statusData => {
      const pieLabels = Object.keys(statusData);
      const pieValues = pieLabels.map(k => statusData[k]);
      const pieColors = pieLabels.map(k => pieChartColors[k.toUpperCase()] || '#bdc3c7');

      if (pieChartInstance) pieChartInstance.destroy();

      pieChartInstance = new Chart(document.getElementById('statusPie').getContext('2d'), {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            data: pieValues,
            backgroundColor: pieColors,
            borderColor: '#f5f7fa',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const total = pieValues.reduce((a, b) => a + b, 0);
      const legendEl = document.getElementById('statusLegend');
      legendEl.innerHTML = `<strong>Total Issues:</strong> ${total}<br><br>`;
      pieLabels.forEach((label, i) => {
        legendEl.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:6px;">
            <div style="width:14px;height:14px;background:${pieColors[i]};margin-right:10px;border-radius:3px;"></div>
            ${label}: <strong style="margin-left:5px;">${pieValues[i]}</strong>
          </div>`;
      });
    });
}

function reloadActionPieChart() {
  const selectedAuditType = document.getElementById('auditTypeSelectActionPie')?.value;

  let url = `${backendURL}/api/finding-action-status-distribution`;
  const params = [];

  if (selectedAuditType) params.push(`auditTypes=${encodeURIComponent(selectedAuditType)}`);
  if (params.length > 0) url += '?' + params.join('&');

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);

      const backgroundColors = labels.map(label => {
        const upper = label.toUpperCase();
        if (upper === 'OVERDUE') return '#e74c3c'; // kırmızı
        if (upper === 'DELAYED') return '#581845'; // koyu bordo
        return predefinedColors[upper] || fallbackColors[colorIndex++ % fallbackColors.length];
      });

      if (actionPieChartInstance) actionPieChartInstance.destroy();

      actionPieChartInstance = new Chart(document.getElementById('actionPie').getContext('2d'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: backgroundColors,
            borderColor: '#f5f7fa',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const total = values.reduce((a, b) => a + b, 0);
      const legendEl = document.getElementById('actionLegend');
      legendEl.innerHTML = `<strong>Total Actions:</strong> ${total}<br><br>`;
      labels.forEach((label, i) => {
        legendEl.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:6px;">
            <div style="width:14px;height:14px;background:${backgroundColors[i]};margin-right:10px;border-radius:3px;"></div>
            ${label}: <strong style="margin-left:5px;">${values[i]}</strong>
          </div>`;
      });
    });
}

let leadStatusChartInstance = null;

function loadLeadStatusChart() {
  fetch(`${backendURL}/api/finding-action-status-by-lead`)
    .then(res => res.json())
    .then(data => {
      const leads = Object.keys(data);
      const statusesSet = new Set();

      leads.forEach(lead => {
        Object.keys(data[lead]).forEach(status => statusesSet.add(status));
      });

      const statuses = Array.from(statusesSet);
      statuses.forEach(status => {
        if (!statusColors[status]) {
          statusColors[status] = predefinedColors[status.toUpperCase()] || fallbackColors[colorIndex++ % fallbackColors.length];
        }
      });

      const datasets = statuses.map(status => {
        return {
          label: status,
          data: leads.map(lead => data[lead][status] || 0),
          backgroundColor: statusColors[status],
          borderRadius: 6
        };
      });

      const config = {
        type: 'bar',
        data: {
          labels: leads,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            datalabels: { display: false }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        },
        plugins: [ChartDataLabels]
      };

      if (leadStatusChartInstance) leadStatusChartInstance.destroy();
      leadStatusChartInstance = new Chart(document.getElementById('leadStatusChart').getContext('2d'), config);
    });
}


  

        // Two Dimensional Table
        fetch(`${backendURL}/api/statistics-by-control-and-risk`)
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById('controlRiskTableContainer');
            const riskLevels = ['Critical', 'High', 'Medium', 'Low'];
            const headers = ['Internal Control Element', ...riskLevels, 'T:'];
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            data.forEach(row => {
              html += '<tr>';
              html += `<td>${row.control}</td>`;
              riskLevels.forEach(level => {
                const count = row[level] || 0;
                if (count > 0 && row.control !== 'Total Unique Issues:') {
                  html += `<td style="cursor:pointer;text-decoration:underline;" onclick="showDetails('${row.control}', '${level}')">${count}</td>`;
                } else {
                  html += `<td>${count}</td>`;
                }
              });
              html += `<td>${row.Total}</td>`;
              html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
          });
  

fetch(`${backendURL}/api/statistics-by-type-and-risk`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('typeRiskTableContainer');
      const riskLevels = ['Critical', 'High', 'Medium', 'Low'];
      const headers = ['Risk Type', ...riskLevels, 'T:'];
      let html = '<table><thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
    data.forEach(row => {
  html += '<tr>';
  html += `<td>${row.type}</td>`;
  riskLevels.forEach(level => {
    const count = row[level] || 0;
    if (count > 0 && row.type !== 'Total Unique Issues:') {
      html += `<td style="cursor:pointer;text-decoration:underline;" onclick="showDetails('${row.type}', '${level}', 'type')">${count}</td>`;
    } else {
      html += `<td>${count}</td>`;
    }
  });
  html += `<td>${row.Total}</td>`;
  html += '</tr>';
});

      html += '</tbody></table>';
      container.innerHTML = html;
    });

  function showDetails(control, risk, mode = 'control') {
  const title = `${control} – ${risk} Risk Findings`;
  document.getElementById('detailTitle').innerText = title;
  document.getElementById('detailList').innerHTML = '<li>Loading...</li>';
  document.getElementById('detailBox').style.display = 'block';

  const url = mode === 'control'
    ? `${backendURL}/api/finding-details-by-control-and-risk?control=${encodeURIComponent(control)}&risk=${encodeURIComponent(risk)}`
    : `${backendURL}/api/finding-details-by-type-and-risk?type=${encodeURIComponent(control)}&risk=${encodeURIComponent(risk)}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('detailList');
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = '<li>No findings found.</li>';
      } else {
        data.forEach(issue => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="https://getir.atlassian.net/browse/${issue.key}" target="_blank">${issue.key}</a>: ${issue.summary}`;
          list.appendChild(li);
        });
      }
    });
}

     function showDetailsByYearAndStatus(year, status) {
  const title = `${status} Findings${year !== 'all' ? ' in ' + year : ''}`;
  document.getElementById('detailTitle').innerText = title;
  document.getElementById('detailList').innerHTML = '<li>Loading...</li>';
  document.getElementById('detailBox').style.display = 'block';

  fetch(`${backendURL}/api/finding-details?year=${encodeURIComponent(year)}&status=${encodeURIComponent(status)}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('detailList');
      list.innerHTML = '';
      if (data.length === 0) {
        list.innerHTML = '<li>No findings found.</li>';
      } else {
        data.forEach(issue => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="https://getir.atlassian.net/browse/${issue.key}" target="_blank">${issue.key}</a>: ${issue.summary}`;
          list.appendChild(li);
        });
      }
    });
}

// ✅ Bu satırı EKLE:
window.showDetailsByYearAndStatus = showDetailsByYearAndStatus;
let actionPieChartInstance = null;

function loadActionPieChart() {
  const selectedAuditType = document.getElementById('auditTypeSelectActionPie')?.value;

  let url = `${backendURL}/api/finding-action-status-distribution`;
  const params = [];

  if (selectedAuditType) params.push(`auditTypes=${encodeURIComponent(selectedAuditType)}`);
  if (params.length > 0) url += '?' + params.join('&');

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const labels = Object.keys(data);
      const values = Object.values(data);

      const backgroundColors = labels.map(label => {
        const upper = label.toUpperCase();
        if (upper === 'OVERDUE') return '#e74c3c'; // kırmızı
        if (upper === 'DELAYED') return '#581845'; // koyu bordo
        return predefinedColors[upper] || fallbackColors[colorIndex++ % fallbackColors.length];
      });

      if (actionPieChartInstance) actionPieChartInstance.destroy();

      actionPieChartInstance = new Chart(document.getElementById('actionPie').getContext('2d'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: backgroundColors,
            borderColor: '#f5f7fa',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                return ((value / total) * 100).toFixed(1) + '%';
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const total = values.reduce((a, b) => a + b, 0);
      const legendEl = document.getElementById('actionLegend');
      legendEl.innerHTML = `<strong>Total Actions:</strong> ${total}<br><br>`;
      labels.forEach((label, i) => {
        legendEl.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:6px;">
            <div style="width:14px;height:14px;background:${backgroundColors[i]};margin-right:10px;border-radius:3px;"></div>
            ${label}: <strong style="margin-left:5px;">${values[i]}</strong>
          </div>`;
      });
    });
}

let auditProgressChartInstance = null;
let auditProgressDropdownsInitialized = false; // ✅ Bir kere initialize edildi mi diye kontrol için

function loadAuditProgressChart() {
  let selectedLead = document.getElementById('auditLeadSelect')?.value;
  let selectedYear = document.getElementById('auditYearSelect')?.value;

  // Sadece ilk yüklemede yıl boşsa 2025 yap
  if (!selectedYear && !auditProgressDropdownsInitialized) {
    selectedYear = '2025';
  }

  fetch(`${backendURL}/api/yearly-audit-plan`)
    .then(res => res.json())
    .then(data => {
      const leads = new Set();
      const years = new Set();

      const filteredData = data
        .filter(d => {
          leads.add(d.auditLead);
          years.add(d.auditYear);
          return (!selectedLead || d.auditLead === selectedLead) &&
                 (!selectedYear || d.auditYear === selectedYear);
        })
        .sort((a, b) => b.progressLevel - a.progressLevel);

      const sortedLeads = Array.from(leads).sort();
      const sortedYears = Array.from(years).sort();

      const leadSelect = document.getElementById('auditLeadSelect');
      const yearSelect = document.getElementById('auditYearSelect');

      // 🔁 Dropdown'ları sadece ilk kez oluştur
      if (!auditProgressDropdownsInitialized) {
        leadSelect.innerHTML = '<option value="">All Leads</option>' +
          sortedLeads.map(l => `<option value="${l}">${l}</option>`).join('');
        yearSelect.innerHTML = '<option value="">All Years</option>' +
          sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');

        leadSelect.value = selectedLead;
        yearSelect.value = selectedYear;

        auditProgressDropdownsInitialized = true; // ✅ Artık yeniden initialize etme
      }

      const allStages = ['Planned', 'Fieldwork', 'Pre Closing', 'Closing', 'Completed'];
      const greyColor = '#ecf0f1';
      const greenColor = '#27ae60';
      const segmentValue = 1 / allStages.length;

      const datasets = allStages.map((stage, idx) => ({
        label: stage,
        data: filteredData.map(() => segmentValue),
        backgroundColor: filteredData.map(d => d.progressLevel > idx ? greenColor : greyColor),
        stack: 'same',
        datalabels: {
          display: true,
          formatter: function (value, context) {
            return allStages[context.datasetIndex];
          },
          color: function (context) {
            const bg = context.dataset.backgroundColor[context.dataIndex];
            return bg === greyColor ? '#7f8c8d' : '#ffffff';
          },
          font: {
            weight: 'normal',
            size: 10
          },
          anchor: 'center',
          align: 'center',
          clamp: true
        },
        borderRadius: 4,
        borderSkipped: false,
        barThickness: 12
      }));

      const ctx = document.getElementById('auditProgressChart').getContext('2d');
      if (auditProgressChartInstance) auditProgressChartInstance.destroy();

      auditProgressChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: filteredData.map(d => d.summary),
          datasets
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { min: 0, max: 1, display: false },
            y: {
              ticks: {
                font: { size: 12, weight: '500' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    });
}




let leadActionAgeChartInstance = null;

function loadLeadActionAgeChart() {
  const select = document.getElementById('auditLeadSelectAge');
  const selectedLead = select.value;
  console.log("SEÇİLEN LEAD:", selectedLead);

  if (select.options.length <= 1) {
    fetch(`${backendURL}/api/finding-action-status-by-lead`)
      .then(res => res.json())
      .then(data => {
        const leads = Object.keys(data).sort();
        leads
          .filter(lead => lead && lead.trim() !== '')
          .forEach(lead => {
            const option = document.createElement('option');
            option.value = lead;
            option.textContent = lead;
            select.appendChild(option);
          });
      });
  }

  const query = selectedLead ? `?lead=${encodeURIComponent(selectedLead)}` : '';
  const baseURL = `${backendURL}/api`;

  // İki API çağrısı birden: open+overdue ve delayed
  const urls = [
    `${baseURL}/finding-action-age-summary${query}`,
    `${baseURL}/finding-action-age-summary-delayed${query}`
  ];

  Promise.all(urls.map(url => fetch(url).then(res => res.json())))
    .then(([openData, delayedData]) => {
      const labels = [
        '-720–-360', '-360–-180', '-180–-90', '-90–-30', '-30–0',
        '0–30', '30–90', '90–180', '180–360', '360–720', '720+'
      ];

      const backgroundColors = [
        '#95a5a6', '#7f8c8d', '#bdc3c7', '#ecf0f1', '#f39c12',
        '#27ae60', '#f1c40f', '#e67e22', '#d35400', '#c0392b', '#8e44ad'
      ];

      // Her bucket için iki API'den gelen veriyi topla
      const combinedValues = labels.map(label => 
        (openData[label] || 0) + (delayedData[label] || 0)
      );

      const config = {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Number of Actions',
            data: combinedValues,
            backgroundColor: backgroundColors,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              display: false,
              formatter: value => value,
              color: '#000',
              font: { weight: 'bold', size: 12 },
              anchor: 'end',
              align: 'start',
              clamp: true
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                maxRotation: 90,
                minRotation: 90,
                align: 'center'
              }
            },
            y: {
              stacked: true,
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      };

      if (leadActionAgeChartInstance) leadActionAgeChartInstance.destroy();
      leadActionAgeChartInstance = new Chart(
        document.getElementById('leadActionAgeChart').getContext('2d'),
        config
      );
    })
    .catch(err => console.error('Error loading combined action age chart:', err));
}
async function loadProjectRiskChart() {
  try {
    const response = await fetch(`${backendURL}/api/finding-risk-distribution-by-project`);
    const data = await response.json();

    const container = document.getElementById('projectRiskTableContainer');
    const riskLevels = ['Critical', 'High', 'Medium', 'Low'];

    // 👇 Audit Year kolonu eklendi
    const headers = ['Audit Project', 'Audit Year', ...riskLevels, 'T:'];

    let html = '<table><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      html += '<tr>';
      html += `<td>${row.project}</td>`;      // Audit Project
      html += `<td>${row.year}</td>`;         // 👈 Audit Year buraya eklendi

      let total = 0;
      riskLevels.forEach(level => {
        const count = row[level] || 0;
        total += count;
        html += `<td>${count}</td>`;
      });

      html += `<td>${total}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Failed to load project risk table:', error);
  }
}

async function loadAuditNameStatusTable() {
  try {
    const response = await fetch(`${backendURL}/api/finding-actions-by-audit-name-and-status`);
    const data = await response.json();

    const container = document.getElementById('auditNameStatusTableContainer');
    const allStatuses = new Set();

    // Tüm unique status'ları topla
    data.forEach(row => {
      Object.keys(row).forEach(key => {
        if (!['auditName', 'auditYear'].includes(key)) {
          allStatuses.add(key);
        }
      });
    });

    const sortedStatuses = Array.from(allStatuses).sort();
    const headers = ['Audit Name', 'Audit Year', ...sortedStatuses, 'T:'];

    let html = '<table><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      let total = 0;
const year = typeof row.auditYear === 'object' ? row.auditYear?.value || 'Unknown' : row.auditYear || 'Unknown';
html += `<tr><td>${row.auditName}</td><td>${year}</td>`;
      sortedStatuses.forEach(status => {
        const count = row[status] || 0;
        html += `<td>${count}</td>`;
        total += count;
      });
      html += `<td>${total}</td></tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Failed to load audit name status table:', error);
  }
}




async function loadInvestigationScores() {
  try {
    const res = await fetch(`${backendURL}/api/investigation-counts`);
    const data = await res.json();
    console.log("Investigation API Response:", data); // 👈 mutlaka ekle

    const container = document.getElementById('investigationScoreCards');
    container.innerHTML = '';

    const grouped = {};
    const auditorCountPerYear = {
      "2020": 2,
      "2021": 7.25,
      "2022": 15.83,
      "2023": 15.17,
      "2024": 9.08,
      "2025": 2.62
    };

    data.forEach(item => {
      if (!grouped[item.year]) grouped[item.year] = 0;
      grouped[item.year] += item.count;
    });

    const years = Object.keys(grouped).sort().reverse();

    years.forEach(year => {
      const total = grouped[year];
      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = (total / auditors).toFixed(2);

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${total}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${perAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load investigation scores:", error);
  }
}


async function loadAuditProjectScoreCards() {
  try {
    const res = await fetch(`${backendURL}/api/finding-risk-distribution-by-project`);
    const data = await res.json();

    const container = document.getElementById('auditProjectScoreCards');
    container.innerHTML = '';

    const auditorCountPerYear = {
      "2020": 2,
      "2021": 7.25,
      "2022": 15.83,
      "2023": 15.17,
      "2024": 9.08,
      "2025": 2.62
    };

    // Yıla göre filtrelenmiş audit count
    const countsPerYear = {};

    data.forEach(item => {
      const year = item.year || 'Unknown';

      if (!countsPerYear[year]) countsPerYear[year] = 0;
      countsPerYear[year]++;
    });

    const years = Object.keys(countsPerYear).sort().reverse();

    years.forEach(year => {
      const totalProjects = countsPerYear[year];
      const auditors = auditorCountPerYear[year] || 1;
      const perAuditor = (totalProjects / auditors).toFixed(2);

      const card = document.createElement('div');
      card.className = 'score-card';

      card.innerHTML = `
        <h3>${year}</h3>
        <div class="count">${totalProjects}</div>
        <p style="font-size:13px; margin-top: 4px; color:#bdc3c7;">${perAuditor} per auditor</p>
      `;

      container.appendChild(card);
    });

  } catch (error) {
    console.error("Failed to load audit project scorecards:", error);
  }
}

  </script>
</body>
</html>